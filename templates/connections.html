{% extends "base.html" %}

{% block title %}连接管理 - BotShepherd{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-diagram-3"></i> 连接管理</h1>
    <button class="btn btn-primary" onclick="showAddConnectionModal()">
        <i class="bi bi-plus-circle"></i>
        添加连接
    </button>
</div>

<!-- 连接状态卡片 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">
                    <i class="bi bi-diagram-3 text-primary"></i>
                    总连接数
                </h5>
                <h3 id="total-connections">0</h3>
                <small class="text-muted">个连接</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">
                    <i class="bi bi-check-circle text-success"></i>
                    活动连接
                </h5>
                <h3 id="active-connections">0</h3>
                <small class="text-muted">个连接</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">
                    <i class="bi bi-x-circle text-danger"></i>
                    离线连接
                </h5>
                <h3 id="offline-connections">0</h3>
                <small class="text-muted">个连接</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">
                    <i class="bi bi-exclamation-triangle text-warning"></i>
                    错误连接
                </h5>
                <h3 id="error-connections">0</h3>
                <small class="text-muted">个连接</small>
            </div>
        </div>
    </div>
</div>

<!-- 连接列表 -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="bi bi-list"></i>
            连接列表（禁用立即生效，其余需重启生效）
        </h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="connections-table">
                <thead>
                    <tr>
                        <th>连接ID</th>
                        <th>名称</th>
                        <th>客户端端点</th>
                        <th>目标端点</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 动态加载 -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 添加/编辑连接模态框 -->
<div class="modal fade" id="connectionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="connectionModalTitle">添加连接</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="connectionForm">
                    <div class="mb-3">
                        <label for="connectionId" class="form-label">连接ID</label>
                        <input type="text" class="form-control" id="connectionId" placeholder="留空自动生成">
                        <div class="form-text">连接的唯一标识符，留空将自动生成</div>
                    </div>

                    <div class="mb-3">
                        <label for="connectionName" class="form-label">连接名称</label>
                        <input type="text" class="form-control" id="connectionName" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="connectionDescription" class="form-label">描述</label>
                        <textarea class="form-control" id="connectionDescription" rows="2"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="clientEndpoint" class="form-label">客户端端点</label>
                        <input type="text" class="form-control" id="clientEndpoint"
                               placeholder="ws://localhost:2537/OneBotv11" required>
                        <div class="form-text">客户端连接的WebSocket地址</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">客户端鉴权请求头 (可选)</label>
                        <div id="clientHeadersList">
                            <!-- 初始为空，点击添加按钮后动态添加 -->
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="addClientHeader()">
                            <i class="bi bi-plus"></i>
                            添加请求头
                        </button>
                        <div class="form-text mt-2">
                            <strong>配置客户端连接时需要验证的请求头</strong><br>
                            客户端连接时需要在请求头中携带匹配的值。参考格式：<br>
                            <code>Authorization: Bearer your_token</code> 或 <code>X-Access-Token: secret_key</code><br>
                            <small class="text-muted">留空则不启用鉴权，任何客户端都可以连接</small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="targetEndpoints" class="form-label">目标端点</label>
                        <div id="targetEndpointsList">
                            <!-- 初始为空，点击添加按钮后动态添加 -->
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="addTargetEndpoint()">
                            <i class="bi bi-plus"></i>
                            添加目标端点
                        </button>
                        <div class="form-text">目标服务器的WebSocket地址</div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="connectionEnabled" checked>
                            <label class="form-check-label" for="connectionEnabled">
                                启用连接
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveConnection()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 连接详情模态框 -->
<div class="modal fade" id="connectionDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">连接详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="connectionDetailContent">
                    <!-- 动态加载 -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let connections = {};
let editingConnectionId = null;

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    loadConnections();
    // setInterval(loadConnections, 10000); // 每10秒刷新
});

// 加载连接列表
async function loadConnections() {
    try {
        const response = await apiRequest('/api/connections');
        connections = response;
        updateConnectionStats();
        updateConnectionTable();
    } catch (error) {
        console.error('加载连接失败:', error);
    }
}

// 更新连接统计
function updateConnectionStats() {
    const total = Object.keys(connections).length;
    let active = 0, offline = 0, error = 0;
    
    Object.values(connections).forEach(conn => {
        if (conn.enabled) {
            active++;
        } else {
            offline++;
        }
    });
    
    document.getElementById('total-connections').textContent = total;
    document.getElementById('active-connections').textContent = active;
    document.getElementById('offline-connections').textContent = offline;
    document.getElementById('error-connections').textContent = error;
}

// 更新连接表格
function updateConnectionTable() {
    const tbody = document.querySelector('#connections-table tbody');
    tbody.innerHTML = '';

    Object.entries(connections).forEach(([connectionId, connection]) => {
        const row = document.createElement('tr');

        const statusBadge = connection.enabled ?
            '<span class="badge bg-success">启用</span>' :
            '<span class="badge bg-secondary">禁用</span>';

        // 处理目标端点显示（支持字符串和对象格式）
        const targetEndpoints = connection.target_endpoints.map(ep => {
            const url = typeof ep === 'string' ? ep : ep.url;
            const isgscore = typeof ep === 'object' && ep.sakoya_protocol;
            const badge = isgscore ? ' <span class="badge bg-info">gscore</span>' : '';
            return `<code>${url}</code>${badge}`;
        }).join('<br>');

        row.innerHTML = `
            <td><code>${connectionId}</code></td>
            <td>${connection.name}</td>
            <td><code>${connection.client_endpoint}</code></td>
            <td><small>${targetEndpoints}</small></td>
            <td>${statusBadge}</td>
            <td>
                <div class="btn-group" role="group">
                    <button class="btn btn-sm btn-outline-primary" onclick="showConnectionDetail('${connectionId}')" title="查看详情">
                        <i class="bi bi-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-warning" onclick="editConnection('${connectionId}')" title="编辑">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="copyConnection('${connectionId}')" title="复制">
                        <i class="bi bi-clipboard"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteConnection('${connectionId}')" title="删除">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </td>
        `;

        tbody.appendChild(row);
    });
}

// 显示添加连接模态框
function showAddConnectionModal() {
    editingConnectionId = null;
    document.getElementById('connectionModalTitle').textContent = '添加连接';
    document.getElementById('connectionForm').reset();
    document.getElementById('connectionId').disabled = false; // 新建时启用ID输入

    // 重置客户端请求头列表为空
    const clientHeadersList = document.getElementById('clientHeadersList');
    clientHeadersList.innerHTML = '';

    // 重置目标端点列表为空
    const targetList = document.getElementById('targetEndpointsList');
    targetList.innerHTML = '';

    new bootstrap.Modal(document.getElementById('connectionModal')).show();
}

// 编辑连接
function editConnection(connectionId) {
    editingConnectionId = connectionId;
    const connection = connections[connectionId];

    document.getElementById('connectionModalTitle').textContent = '编辑连接';
    document.getElementById('connectionId').value = connectionId;
    document.getElementById('connectionId').disabled = true; // 编辑时禁用ID修改
    document.getElementById('connectionName').value = connection.name;
    document.getElementById('connectionDescription').value = connection.description || '';
    document.getElementById('clientEndpoint').value = connection.client_endpoint;
    document.getElementById('connectionEnabled').checked = connection.enabled;

    // 填充客户端鉴权请求头
    const clientHeadersList = document.getElementById('clientHeadersList');
    clientHeadersList.innerHTML = '';

    // 优先使用 client_headers，否则使用 api_key（向后兼容）
    if (connection.client_headers) {
        for (const [key, value] of Object.entries(connection.client_headers)) {
            addClientHeaderField(clientHeadersList, key, value);
        }
    } else if (connection.api_key) {
        // 向后兼容：将 api_key 转换为 Authorization 请求头
        addClientHeaderField(clientHeadersList, 'Authorization', connection.api_key);
    }

    // 填充目标端点
    const targetList = document.getElementById('targetEndpointsList');
    targetList.innerHTML = '';

    connection.target_endpoints.forEach(endpoint => {
        // 兼容字符串格式和对象格式
        let url = '';
        let sakoyaProtocol = false;
        let headers = {};

        if (typeof endpoint === 'string') {
            url = endpoint;
            sakoyaProtocol = false;
            headers = {};
        } else if (typeof endpoint === 'object') {
            url = endpoint.url || '';
            sakoyaProtocol = endpoint.sakoya_protocol || false;
            headers = endpoint.headers || {};
        }

        addTargetEndpoint(url, sakoyaProtocol, headers);
    });

    new bootstrap.Modal(document.getElementById('connectionModal')).show();
}

// 添加目标端点
function addTargetEndpoint(url = '', sakoyaProtocol = false, headers = {}) {
    const targetList = document.getElementById('targetEndpointsList');
    const div = document.createElement('div');
    div.className = 'mb-2 p-3 border rounded position-relative';
    div.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
            <label class="form-label mb-0">目标端点</label>
            <button class="btn btn-sm btn-outline-danger" type="button" onclick="removeTargetEndpoint(this)">
                <i class="bi bi-trash"></i>
            </button>
        </div>
        <input type="text" class="form-control mb-2 target-endpoint-url"
               placeholder="ws://localhost:2536/OneBotv11" value="${url}">
        <div class="mb-2">
            <label class="form-label">自定义请求头 (可选)</label>
            <div class="target-headers-list">
                <!-- 动态添加请求头 -->
            </div>
            <button type="button" class="btn btn-outline-secondary btn-sm mt-1" onclick="addTargetHeader(this)">
                <i class="bi bi-plus"></i>
                添加请求头
            </button>
            <div class="form-text mt-1">
                连接到目标服务器时携带的请求头。参考格式：<br>
                <code>Authorization: Bearer token</code> 或 <code>X-Api-Key: your_key</code>
            </div>
        </div>
        <div class="form-check">
            <input class="form-check-input target-endpoint-sakoya" type="checkbox" ${sakoyaProtocol ? 'checked' : ''}>
            <label class="form-check-label">
                早柚协议 <span class="badge bg-info">gscore</span>
            </label>
            <div class="form-text">启用后将自动转换早柚协议和 OneBot v11 协议</div>
        </div>
    `;
    targetList.appendChild(div);

    // 添加已有的请求头
    const headersList = div.querySelector('.target-headers-list');
    for (const [key, value] of Object.entries(headers)) {
        addTargetHeaderField(headersList, key, value);
    }
}

// 移除目标端点
function removeTargetEndpoint(button) {
    const targetList = document.getElementById('targetEndpointsList');
    // 找到包含按钮的最外层div（mb-2 p-3 border rounded position-relative）
    const targetDiv = button.closest('.mb-2.p-3.border.rounded');
    if (targetList.children.length > 0 && targetDiv) {
        targetDiv.remove();
    } else {
        showToast('没有可删除的目标端点', 'warning');
    }
}

// 保存连接
async function saveConnection() {
    try {
        const customConnectionId = document.getElementById('connectionId').value.trim();
        const name = document.getElementById('connectionName').value.trim();
        const description = document.getElementById('connectionDescription').value.trim();
        const clientEndpoint = document.getElementById('clientEndpoint').value.trim();
        const enabled = document.getElementById('connectionEnabled').checked;

        // 收集客户端鉴权请求头
        const clientHeaders = {};
        document.querySelectorAll('#clientHeadersList > div').forEach(div => {
            const keyInput = div.querySelector('.client-header-key');
            const valueInput = div.querySelector('.client-header-value');
            if (keyInput && valueInput) {
                const key = keyInput.value.trim();
                const value = valueInput.value.trim();
                if (key && value) {
                    // 请求头名称转为小写以保持一致性
                    clientHeaders[key.toLowerCase()] = value;
                }
            }
        });

        // 收集目标端点（支持对象格式）
        const targetEndpoints = [];
        document.querySelectorAll('#targetEndpointsList > div').forEach(div => {
            const urlInput = div.querySelector('.target-endpoint-url');
            const sakoyaCheckbox = div.querySelector('.target-endpoint-sakoya');
            if (urlInput) {
                const url = urlInput.value.trim();
                if (url) {
                    const endpointData = {
                        url: url,
                        sakoya_protocol: sakoyaCheckbox ? sakoyaCheckbox.checked : false
                    };

                    // 收集目标端点的自定义请求头
                    const headers = {};
                    div.querySelectorAll('.target-headers-list > div').forEach(headerDiv => {
                        const keyInput = headerDiv.querySelector('.target-header-key');
                        const valueInput = headerDiv.querySelector('.target-header-value');
                        if (keyInput && valueInput) {
                            const key = keyInput.value.trim();
                            const value = valueInput.value.trim();
                            if (key && value) {
                                headers[key] = value;
                            }
                        }
                    });

                    if (Object.keys(headers).length > 0) {
                        endpointData.headers = headers;
                    }

                    targetEndpoints.push(endpointData);
                }
            }
        });

        if (!name || !clientEndpoint) {
            showToast('请填写连接名称和客户端端点', 'warning');
            return;
        }

        // 如果是新建连接且提供了自定义ID，检查是否已存在
        if (!editingConnectionId && customConnectionId && connections[customConnectionId]) {
            showToast('连接ID已存在，请使用其他ID', 'warning');
            return;
        }

        const connectionData = {
            name,
            description,
            client_endpoint: clientEndpoint,
            target_endpoints: targetEndpoints,
            enabled
        };

        // 如果有客户端鉴权请求头，添加到连接数据
        if (Object.keys(clientHeaders).length > 0) {
            // 为了向后兼容，如果只有 authorization 头，将其作为 api_key 存储
            if (Object.keys(clientHeaders).length === 1 && clientHeaders.authorization) {
                connectionData.api_key = clientHeaders.authorization;
            } else {
                connectionData.client_headers = clientHeaders;
            }
        }

        // 确定最终使用的connectionId
        let finalConnectionId;
        if (editingConnectionId) {
            // 编辑模式，使用原有ID
            finalConnectionId = editingConnectionId;
        } else if (customConnectionId) {
            // 新建模式，使用自定义ID
            finalConnectionId = customConnectionId;
        } else {
            // 新建模式，自动生成ID
            finalConnectionId = `conn_${Date.now()}`;
        }

        await apiRequest(`/api/connections/${finalConnectionId}`, {
            method: 'PUT',
            body: JSON.stringify(connectionData)
        });

        showToast(editingConnectionId ? '连接更新成功' : '连接添加成功', 'success');
        bootstrap.Modal.getInstance(document.getElementById('connectionModal')).hide();
        loadConnections();

    } catch (error) {
        showToast(`保存连接失败: ${error.message}`, 'danger');
    }
}

// 删除连接
async function deleteConnection(connectionId) {
    if (!confirm('确定要删除这个连接吗？')) {
        return;
    }
    
    try {
        await apiRequest(`/api/connections/${connectionId}`, {
            method: 'DELETE'
        });
        
        showToast('连接删除成功', 'success');
        loadConnections();
    } catch (error) {
        showToast(`删除连接失败: ${error.message}`, 'danger');
    }
}

// 复制连接
async function copyConnection(connectionId) {
    const newId = prompt('请输入新连接的ID:', connectionId + '_copy');
    if (!newId || newId.trim() === '') {
        return;
    }

    if (connections[newId.trim()]) {
        showToast('连接ID已存在', 'warning');
        return;
    }

    try {
        await apiRequest(`/api/connections/${connectionId}/copy`, {
            method: 'POST',
            body: JSON.stringify({
                new_id: newId.trim()
            })
        });

        showToast('连接已复制', 'success');
        loadConnections();
    } catch (error) {
        console.error('复制连接失败:', error);
        showToast('复制连接失败: ' + error.message, 'danger');
    }
}

// 显示连接详情
function showConnectionDetail(connectionId) {
    const connection = connections[connectionId];
    
    const content = `
        <div class="row">
            <div class="col-md-6">
                <h6>基本信息</h6>
                <table class="table table-sm">
                    <tr><td>连接ID</td><td><code>${connectionId}</code></td></tr>
                    <tr><td>名称</td><td>${connection.name}</td></tr>
                    <tr><td>描述</td><td>${connection.description || '无'}</td></tr>
                    <tr><td>状态</td><td>${connection.enabled ? '启用' : '禁用'}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>端点信息</h6>
                <table class="table table-sm">
                    <tr><td>客户端端点</td><td><code>${connection.client_endpoint}</code></td></tr>
                    <tr><td>目标端点</td><td>
                        ${connection.target_endpoints.map(ep => {
                            const url = typeof ep === 'string' ? ep : ep.url;
                            const isgscore = typeof ep === 'object' && ep.sakoya_protocol;
                            const badge = isgscore ? ' <span class="badge bg-info">gscore</span>' : '';
                            return `<code>${url}</code>${badge}`;
                        }).join('<br>')}
                    </td></tr>
                </table>
            </div>
        </div>
    `;
    
    document.getElementById('connectionDetailContent').innerHTML = content;
    new bootstrap.Modal(document.getElementById('connectionDetailModal')).show();
}

// ==================== 客户端请求头管理 ====================

// 添加客户端请求头按钮点击事件
function addClientHeader() {
    const clientHeadersList = document.getElementById('clientHeadersList');
    addClientHeaderField(clientHeadersList);
}

// 添加客户端请求头字段
function addClientHeaderField(container, key = '', value = '') {
    const div = document.createElement('div');
    div.className = 'input-group mb-2';
    div.innerHTML = `
        <input type="text" class="form-control client-header-key" placeholder="请求头名称 (如 Authorization)" value="${key}">
        <input type="text" class="form-control client-header-value" placeholder="值 (如 Bearer token123)" value="${value}">
        <button class="btn btn-outline-danger" type="button" onclick="removeClientHeader(this)">
            <i class="bi bi-trash"></i>
        </button>
    `;
    container.appendChild(div);
}

// 删除客户端请求头
function removeClientHeader(button) {
    button.closest('.input-group').remove();
}

// ==================== 目标端点请求头管理 ====================

// 添加目标端点请求头按钮点击事件
function addTargetHeader(button) {
    const targetDiv = button.closest('.mb-2.p-3.border.rounded');
    const headersList = targetDiv.querySelector('.target-headers-list');
    addTargetHeaderField(headersList);
}

// 添加目标端点请求头字段
function addTargetHeaderField(container, key = '', value = '') {
    const div = document.createElement('div');
    div.className = 'input-group input-group-sm mb-1';
    div.innerHTML = `
        <input type="text" class="form-control target-header-key" placeholder="请求头名称" value="${key}">
        <input type="text" class="form-control target-header-value" placeholder="值" value="${value}">
        <button class="btn btn-outline-secondary" type="button" onclick="removeTargetHeader(this)">
            <i class="bi bi-trash"></i>
        </button>
    `;
    container.appendChild(div);
}

// 删除目标端点请求头
function removeTargetHeader(button) {
    button.closest('.input-group').remove();
}
</script>
{% endblock %}
